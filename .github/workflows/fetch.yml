name: Fetch ETH 1m klines every 15m

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

# ← これが超重要。GITHUB_TOKEN に書き込み権限を付与
permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # push まで同じ資格情報を使う
          persist-credentials: true
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fetch and save CSV
        run: |
          python scripts/fetch_eth.py
          
# 既存のjobs.fetch.stepsの末尾付近に、Commit前に挿入
      - name: Analyze and publish summary JSON
        run: |
          python scripts/analyze_and_publish.py

      - name: Duplicate JSON for Raw access
        run: |
          cp docs/eth_summary.json eth_summary.json
          git add eth_summary.json

      - name: Configure git and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 念のため最新を取得（main が進んでいても対応できるように）
          git fetch origin main

          # 変更をステージング & 一旦コミット
          git add docs/*
          if ! git diff --cached --quiet; then
            git commit -m "auto: update CSV ($(date -u +"%Y-%m-%dT%H:%M:%SZ"))"
          else
            echo "No changes to commit."
          fi

          # main を最新に合わせてリベース（競合ほぼ出ません）
          git pull --rebase origin main || true

          # トークン付きURLで安全に push
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

          # 競合がなければ通常 push、もし再び進んでいたら最終手段で lease 付き force
          if git push origin HEAD:main; then
            echo "Pushed normally."
          else
            echo "Non-fast-forward, trying force-with-lease..."
            git push --force-with-lease origin HEAD:main
          fi

